########################################################################
# WEBSITE https://flowork.cloud
# File NAME : C:\FLOWORK\docker-compose.yml total lines 109 
########################################################################

name: flowork

networks:
  flowork-net:
    driver: bridge

services:
  flowork_gateway:
    image: flowork/gateway:dev
    container_name: flowork_gateway
    build:
      context: ./flowork-gateway
      dockerfile: Dockerfile
    env_file:
      - .env
    entrypoint: ["/bin/bash", "-c", "dos2unix /app/entrypoint.sh && /app/entrypoint.sh && echo '[Flowork Entrypoint] Seeding default engine from .env to DB...' && python seed_dev_engine.py"]
    volumes:
      - ./flowork-gateway:/app
      - ./data:/app/data
      - ./healthchecks:/app/healthchecks
      - ./.env:/app/.env
    ports:
      - "${GW_PORT:-8000}:8000"
    networks:
      flowork-net:
        aliases:
          - gateway
    healthcheck:
      test: ["CMD-SHELL", "python /app/healthchecks/health_gateway.py"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    restart: unless-stopped

  flowork_core:
    image: flowork/core:dev
    container_name: flowork_core
    build:
      context: ./flowork-core
      dockerfile: Dockerfile
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility,video

    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

    volumes:
      - ./flowork-core:/app
      - ./data:/app/data
      - ./training:/app/training
      - ./.env:/app/.env
      - ./modules:/app/flowork_kernel/modules
      - ./plugins:/app/flowork_kernel/plugins
      - ./tools:/app/flowork_kernel/tools
      - ./triggers:/app/flowork_kernel/triggers
      - ./widgets:/app/flowork_kernel/widgets
      - ./ai_providers:/app/flowork_kernel/ai_providers
      - ./ai_models:/app/flowork_kernel/ai_models
      - ./formatters:/app/flowork_kernel/formatters
      - ./scanners:/app/flowork_kernel/scanners
      - ./assets:/app/flowork_kernel/assets
      - "${USERPROFILE}/Videos:/mnt/videos"

    ports:
      - "${CORE_PORT_TCP:-8989}:8989"
      - "${CORE_PORT_HTTP:-8990}:8990"
      - "${CORE_PORT_SOCKET:-5001}:5001"
    networks:
      - flowork-net
    depends_on:
      flowork_gateway:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python /app/healthchecks/health_core.py"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    stdin_open: true
    tty: true

  flowork_cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: flowork_cloudflared
    restart: unless-stopped
    networks:
      - flowork-net
    command: tunnel --no-autoupdate run --token ${TUNNEL_TOKEN}
    depends_on:
      flowork_gateway:
        condition: service_healthy
